"use strict";function cargaPrestados(t){let e=$("#array_corte_prestados").val(),a="";a=t?JSON.parse(e):JSON.parse(e.replace(/&quot;/g,'"'));let o=$("#array_cp").val(),n=JSON.parse(o.replace(/&quot;/g,'"'));console.log(a);let s={};a.forEach(t=>{s.hasOwnProperty(t.clienteId)||(s[t.clienteId]=[]),s[t.clienteId].push(t)});Object.entries(s);var l=$(".datatables-basicPrestados");if(l.length){$(".dt-column-searchPrestados thead tr").clone(!0).appendTo(".dt-column-searchPrestados thead"),$(".dt-column-searchPrestados thead tr:eq(1) th").each(function(t){var e=$(this).text();$(this).html('<input type="text" class="form-control form-control-sm" placeholder="Buscar '+e+'" />'),$("input",this).on("keyup change",function(){r.column(t).search()!==this.value&&r.column(t).search(this.value).draw()})});var r=l.DataTable({data:a,columns:[{data:"cliente",render:function(t,e,a,o){let s=a.cantidad;var l=encodeURIComponent(JSON.stringify(a));let r="";for(let t=0;t<n.length;t++)n[t].id==a.cliente.cpId&&(r=n[t].asentamiento);var c=a.cliente.tipo,d={Residencial:{title:a.cliente.firstName+" "+a.cliente.lastName+" / "+r,class:"badge-light-info"},"Punto de venta":{title:a.cliente.firstName+" "+a.cliente.lastName+" / "+r,class:" badge-light-success"},Negocio:{title:a.cliente.firstName+" "+a.cliente.lastName+" / "+r,class:" badge-light-danger"}};if(void 0===d[c])return t;return null==a.cliente.etiqueta?(0,"black"):(a.cliente.etiqueta.color,"white"),`<span class="d-none">${r}</span><span class="badge rounded-pill ${d[c].class}" data-bs-toggle="modal" data-id="${s}" data-arrayconductores="${l}" data-title="Garrafones Prestados a ${a.cliente.firstName}"  data-bs-target="#corte_modal" style="cursor: pointer;">${d[c].title}</span>`}},{data:"cantidad"},{data:"fecha_ingreso"},{data:"devueltos"},{data:"fecha_devolucion"}],columnDefs:[{targets:1,className:"to_total2",render:function(t,e,a,o){return`<span class="cantidad">${t}</span>`}},{targets:2,render:function(t,e,a,o){return`<span class="d-none">${moment(t).format("YYYYMMDD")}</span>${moment(t).format("DD/MM/YYYY")}`}},{targets:4,render:function(t,e,a,o){let n="";return null!=t&&(n=`<span class="d-none">${moment(t).format("YYYYMMDD")}</span>${moment(t).format("DD/MM/YYYY")}`),n}}],order:[[2,"desc"]],dom:'<"none "<"col-sm-12 col-md-6"l><"col-sm-12 col-md-6"f>>t<"d-flex justify-content-between mx-0 row"<"col-sm-12 col-md-6"i><"col-sm-12 col-md-6"p>>',orderCellsTop:!0,displayLength:10,lengthMenu:[7,10,25,50,75,100],language:{decimal:"",emptyTable:"No hay información",info:"Total _TOTAL_ registros",infoEmpty:"Total _TOTAL_ registros",infoFiltered:"(Filtrado de _MAX_ registros totales)",infoPostFix:"",thousands:",",lengthMenu:"Mostrar _MENU_ Entradas",loadingRecords:"Cargando...",processing:"Procesando...",search:"Buscar:",zeroRecords:"Sin resultados encontrados",paginate:{previous:"&nbsp;",next:"&nbsp;"}},drawCallback:function(t){let e=0;$(".datatables-basicPrestados").dataTable().$(".cantidad").each(function(){"-"==$(this).text()||(e+=parseFloat($(this).text()))}),$("#Prestados_info").append(`<span> / Total prestados: ${e} </span>`);var a=this.api();a.rows({page:"current"}).nodes();let o=0;a.column(1,{page:"current"}).data().each(function(t,e){o+=parseInt(t)}),$("tfoot .to_total2").text(o)}});$("#min_, #max_").on("change",function(){filterByDate__(2),r.draw()}),$("#corte_modal").on("show.bs.modal",function(t){var e=$(t.relatedTarget),a=(e.data("id"),e.data("title")),o=e.data("arrayconductores"),n=JSON.parse(decodeURIComponent(o));$("#corte_modalTitle").text(a),$("#corte_modalBody").empty();let s=n.cantidad;console.log(n);let l=n.clienteId+","+n.fecha_ingreso+","+n.personalId+","+s;$("#corte_modalBody").append(`<ul class='list-group list-group-flush'><li class='list-group-item d-flex justify-content-between align-items-center'>Chofer ${n.personal.name}: <span class='badge bg-primary rounded-pill'>Prestados: ${s}</span><input type="text" id="${l}" placeholder="Indique la cantidad a devolver" onchange="habilitar_dev(this)" onclick="$(this).removeAttr('readonly');" readonly/> </li></ul>`)})}let c,d=$("#fecha_corte").val();c=a.filter(t=>t.fecha_ingreso==moment().format("MM/DD/YYYY")),""!=d&&(c=a.filter(t=>t.fecha_ingreso==moment(d,"DD/MM/YYYY").format("MM/DD/YYYY"))),console.log(c);let i=0,h=0;for(let t=0;t<c.length;t++)i+=parseInt(c[t].cantidad),h+=parseInt(c[t].devueltos);$("#prestamos_del_dia").text(i),$("#devueltos_del_dia").text(h)}async function habilitar_dev(t){console.log(t.id);let e=t.id.split(","),a=e[1],o=e[2],n=e[3],s=e[0];a=a.replaceAll("/","-"),console.log(a),parseInt(t.value)>parseInt(n)?Swal.fire("La cantidad de devueltos no debe ser mayor a la prestada"):Swal.fire({title:"Seguro desea actualizar los devueltos",showCancelButton:!0,confirmButtonText:"Confirmar",cancelButtonText:"Cancelar",showLoaderOnConfirm:!0,preConfirm:e=>fetch(`/actualizar_devueltos/${o}/${t.value}/${s}/${a}`).then(t=>{if(!t.ok)throw new Error(t.statusText);return t.json()}).catch(t=>{Swal.showValidationMessage(`Request failed: ${t}`)}),allowOutsideClick:()=>!Swal.isLoading()}).then(async t=>{if(t.isConfirmed){console.log(t),Swal.fire("Listo");let e=moment(a,"MM-DD-YYYY").format("YYYY-DD-MM");console.log(e);let o=await fetch("/prestados/"+e).then(t=>t.json()).then(t=>t.prestamos_byday);console.log(JSON.parse(o)),$(".datatables-basicPrestados").dataTable().fnDestroy(),$(".datatables-basicPrestados").empty(),$(".datatables-basicPrestados").html('<thead>\n          <tr>\n              <th>Cliente</th>\n              <th>Nª Envases Prestados</th>\n              <th>Fecha</th>\n              <th>Devueltos</th>\n              <th>Fecha Ult. Devolución</th>\n          </tr>\n      </thead>\n      <tfoot>\n<tr>\n<th colspan="1" style="text-align:right"> Total</th>\n<th></th>\n<th></th>\n<th></th>\n<th></th>\n</tr>\n</tfoot>'),$("#array_corte_prestados").val(o),cargaPrestados("rest")}})}$(function(){cargaPrestados(),$("#fecha_corte").on("change",async t=>{console.log(t.target.value);let e=moment(t.target.value,"DD/MM/YYYY").format("YYYY-DD-MM");console.log(e);let a=await fetch("/prestados/"+e).then(t=>t.json()).then(t=>t.prestamos_byday);console.log(JSON.parse(a)),$(".datatables-basicPrestados").dataTable().fnDestroy(),$(".datatables-basicPrestados").empty(),$(".datatables-basicPrestados").html('<thead>\n        <tr>\n            <th>Cliente</th>\n            <th>Nª Envases Prestados</th>\n            <th>Fecha</th>\n            <th>Devueltos</th>\n            <th>Fecha Ult. Devolución</th>\n        </tr>\n    </thead>\n    <tfoot>\n<tr>\n<th colspan="1" style="text-align:right"> Total</th>\n<th></th>\n<th></th>\n<th></th>\n<th></th>\n</tr>\n</tfoot>'),$("#array_corte_prestados").val(a),cargaPrestados("rest")})});